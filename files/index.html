<!DOCTYPE html>
<head>
  <meta charset=utf-8 />
  <style>
    body { 
      font: 8px helvetica neue, helvetica, arial, sans-serif;
    } 

    #cy {
      position: absolute;
      left: 50px;
      top: 50px;
      bottom: 50px;
      right: 50px;
    }
  </style>
  <script>
    //TODO make it a separate module

    class GraphClicker {

      constructor(vx0) {
        //initial vx
        this.vx0 = vx0;
        //displayed subgraph 
        this.displayed_nodes_set = new Set();
        this.displayed_edges_set = new Set();

        this.reset_added();
        this.displayed_nodes_set.add(vx0);

        this.last_clicked_id = 0;

        //these function will be called from an event handlers
        //therefore they need to be bound to the class instance
        //otherwise, "this" will be the outer context of the handler
        //https://stackoverflow.com/questions/20279484/how-to-access-the-correct-this-inside-a-callback
        this.on_graph_click = this.on_graph_click.bind(this);
        this.on_mouseover = this.on_mouseover.bind(this);
        this.on_mouseout = this.on_mouseout.bind(this);
      }

      async jsonData(url = '', data = {}) {
        // Default options are marked with *
        const response = await fetch(url, {
          method: 'POST', // *GET, POST, PUT, DELETE, etc.
          mode: 'same-origin', // no-cors, *cors, same-origin
          cache: 'no-cache', // *default, no-cache, reload, force-cache, only-if-cached
          credentials: 'same-origin', // include, *same-origin, omit
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(data) // body data type must match "Content-Type" header
        });
        return response.json(); // parses JSON response into native JavaScript objects
      }

      to_cy_edge(api_edge) {
        //TODO webworker and/or WASM
        var cy_edge = new Object();
        cy_edge.group = "edges";
        var edge_data = new Object();
        edge_data.id = "e"+api_edge.id;
        edge_data.source = "n"+api_edge.orig_vx;
        edge_data.target = "n"+api_edge.dest_vx;
        edge_data.clicked = this.last_clicked_id;
        edge_data.value = api_edge.value;
        edge_data.bl_height = api_edge.bl_height;
        cy_edge.data = edge_data;
        return cy_edge;
      }

      to_cy_node(id) {
        var cy_node = new Object();
        cy_node.group = "nodes";
        var node_data = new Object();
        node_data.id = "n"+id;
        node_data.clicked = this.last_clicked_id;
        cy_node.data = node_data;
        return cy_node;
      }


      on_new_edges(api_edges) {
        api_edges.forEach( api_edge => {
          if (!this.displayed_nodes_set.has(api_edge.orig_vx)) {
            //add node
            this.added_eles['nodes'].push(this.to_cy_node(api_edge.orig_vx));
            this.displayed_nodes_set.add(api_edge.orig_vx);
          }
          if (!this.displayed_nodes_set.has(api_edge.dest_vx)) { 
            //add node
            this.added_eles['nodes'].push(this.to_cy_node(api_edge.dest_vx));
            this.displayed_nodes_set.add(api_edge.dest_vx);
          }
          if (!this.displayed_edges_set.has(api_edge.id)) {
            //add edge
            this.added_eles['edges'].push(this.to_cy_edge(api_edge));
            this.displayed_edges_set.add(api_edge[0]);
          }
        }
        )
      }

      on_graph_click(evt) {
        var el_type;
        if (evt.target['elements']) {
          el_type = 'g';
          //TODO clicked on graph bg
          console.log(`TODO reset the graph?`);
        } else {
          console.info( `graph click ${evt.target.id()}` );
          var target_el_id = evt.target.id();
          el_type = target_el_id.charAt(0);
          this.last_clicked_id = parseInt(target_el_id.slice(1));
          switch (el_type) {
            case 'n':
              this.on_vx_click();
              break;
            case 'e':
              this.on_edge_click();
              break;
          }
        }
      }

      on_mouseover(evt) {
        if (evt.target['id']) {
          //I add styles here for performance reasons. Check this.
          console.info( 'mouse over ' + evt.target.id() );
          evt.target.style('font-size', '6px');
          evt.target.style('text-valign', 'center');
          var target_el_id = evt.target.id();
          let el_type = target_el_id.charAt(0);
          switch (el_type) {
            case 'n':
              this.on_node_mouseover(evt.target);
              break;
            case 'e':
              this.on_edge_mouseover(evt.target);
              break;
          }
        }
      }

      on_edge_mouseover(edge) {
        edge.style('label', `${edge.data('value')/1e8}BTC at ${edge.data('bl_height')}`);
      }

      on_node_mouseover(node) {
        node.style('label', `${node.id()}`);
      }

      on_mouseout(evt) {
        if (evt.target['id']) {
          console.info( 'mouse out ' + evt.target.id() );
          evt.target.style('label', '');
        }
      }

      on_vx_click() {
        this.jsonData('/graph', { "vx_vec": [this.last_clicked_id], "bl_min" : 0, "bl_max": 100000, "flux_threshold": 0 })
          .then(edges => {
            console.info("from server", edges); // JSON data parsed by `data.json()` call
            this.reset_added();
            this.on_new_edges(edges);
            console.info("adding to graph", this.added_eles);
            cy.add(this.added_eles);
            //TODO run layout on collection of new elements
            var new_eles = cy.filter(`[clicked=${this.last_clicked_id}]`);
            var lt = new_eles.layout({ name: 'circle' });
            lt.run();
            cy.fit();
          });
      }

      on_edge_click() {
        console.log("TODO impl edge click");
      }

      reset_added() {
        this.added_eles = {'nodes': [], 'edges': []};
      }

    }
  </script>


<script src="https://cdnjs.cloudflare.com/ajax/libs/cytoscape/3.15.1/cytoscape.min.js"></script>
<title>GraphData Demo</title>
</head>
<body>
<div id="cy"></div>
<!-- Load application code at the end to ensure DOM is loaded -->
<script>

  var n0 = 744;
  var clicker = new GraphClicker(n0);

  var cy = window.cy = cytoscape({
    // these options hide parts of the graph during interaction
    //hideEdgesOnViewport: true,
    //hideLabelsOnViewport: true,

    // this is an alternative that uses a bitmap during interaction
    // textureOnViewport: true,

    // interpolate on high density displays instead of increasing resolution
    // pixelRatio: 1,

    // a motion blur effect that increases perceived performance for little or no cost
    motionBlur: true,

    container: document.getElementById('cy'),

    style: cytoscape.stylesheet()
      .selector('node')
        .css({
          'width': '5',
          'height': '5',
          'background-color' : '#9dbaea'
        })
      .selector('edge')
        .css({
          'width': 0.5,
          'curve-style' : 'bezier',
          'line-color' : '#9dbaea',
          'target-arrow-color': '#9dbaea',
          'target-arrow-shape': 'triangle-backcurve' 
        }),

    layout: {
      name: 'circle',
      height: 100,
    },

    elements: clicker.to_cy_node(n0)  
  });
  //event handlers
  cy.on('tapstart', clicker.on_graph_click);
  cy.on('mouseover', clicker.on_mouseover);
  cy.on('mouseout', clicker.on_mouseout);

  
 
  
</script>
</body>
</html>
